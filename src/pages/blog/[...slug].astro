---
/**
 * Dynamic Blog Post Page
 *
 * Renders individual blog posts with full SEO optimization.
 * Supports both Markdown (.md) and MDX (.mdx) formats.
 *
 * Features:
 * - Full Open Graph and Twitter Card meta tags
 * - JSON-LD structured data for search engines
 * - Automatic table of contents generation from headings
 * - Hero image support with optimization
 * - Author and publication date metadata
 * - Tag display for categorization
 *
 * The [...slug] pattern creates a catch-all route that matches any blog post ID.
 */
import { getCollection, type CollectionEntry, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Picture } from "astro:assets";
import AuthorBio from "../../components/AuthorBio.astro";
import BlogTag from "../../components/BlogTag.astro";
import { getReadingTime, getWordCount } from "../../utils/reading-time";
import { fadeAnimation } from "../../utils/transitions";

/**
 * Generate static paths for all blog posts at build time
 *
 * Astro calls this function during the build process to create
 * a static HTML file for each blog post.
 */
export async function getStaticPaths() {
	const posts = await getCollection("blog");
	// Sort posts by date (newest first)
	const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
	
	return sortedPosts.map((post, index) => {
		const prevPost = index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null;
		const nextPost = index > 0 ? sortedPosts[index - 1] : null;
		
		return {
			params: { slug: post.id },
			props: { 
				post,
				prevPost,
				nextPost,
			},
		};
	});
}

type Props = {
	post: CollectionEntry<"blog">;
	prevPost: CollectionEntry<"blog"> | null;
	nextPost: CollectionEntry<"blog"> | null;
};

const { post } = Astro.props;

// Render the Markdown/MDX content into HTML
// Content: The rendered component to display the post body
const { Content } = await render(post);

// Calculate reading time and word count from post body
const readingTime = getReadingTime(post.body ?? "");
const wordCount = getWordCount(post.body ?? "");

// Generate canonical URL for SEO
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Extract frontmatter data from the post
const { title, description, pubDate, updatedDate, author, tags, heroImage, heroImageAlt, heroImageCaption } = post.data;

/**
 * Generate JSON-LD structured data for search engines
 *
 * This helps Google and other search engines understand the content
 * and display rich results in search (author, date, etc.)
 *
 * @see https://schema.org/BlogPosting
 * @see https://schema.org/BreadcrumbList
 */
const structuredData = {
	"@context": "https://schema.org",
	"@graph": [
		{
			"@type": "BlogPosting",
			"@id": canonicalURL + "#article",
			headline: title,
			description: description,
			url: canonicalURL.toString(),
			mainEntityOfPage: {
				"@type": "WebPage",
				"@id": canonicalURL.toString(),
			},
			author: {
				"@type": "Person",
				"@id": "https://peterchrjoergensen.dk/#person",
				name: author,
			},
			publisher: {
				"@type": "Person",
				"@id": "https://peterchrjoergensen.dk/#person",
				name: "Peter Chr. Jørgensen",
				url: "https://peterchrjoergensen.dk",
			},
			datePublished: pubDate.toISOString(),
			...(updatedDate && { dateModified: updatedDate.toISOString() }),
			inLanguage: "en-US",
			wordCount: wordCount,
			keywords: tags?.join(", ") || "",
			...(heroImage && {
				image: {
					"@type": "ImageObject",
					url: new URL(heroImage.src, Astro.site).toString(),
					width: heroImage.width,
					height: heroImage.height,
				},
			}),
		},
		{
			"@type": "BreadcrumbList",
			itemListElement: [
				{
					"@type": "ListItem",
					position: 1,
					name: "Home",
					item: "https://peterchrjoergensen.dk",
				},
				{
					"@type": "ListItem",
					position: 2,
					name: "Blog",
					item: "https://peterchrjoergensen.dk/blog",
				},
				{
					"@type": "ListItem",
					position: 3,
					name: title,
					item: canonicalURL.toString(),
				},
			],
		},
	],
};
---

<Layout 
	title={title} 
	description={description}
>
	<Fragment slot="head">
		<!-- 
			Social Media Meta Tags
			These control how the post appears when shared on social platforms
		-->
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="article" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		{heroImage && <meta property="og:image" content={new URL(heroImage.src, Astro.site)} />}
		
		<!-- Twitter -->
		<meta property="twitter:card" content={heroImage ? "summary_large_image" : "summary"} />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		{heroImage && <meta property="twitter:image" content={new URL(heroImage.src, Astro.site)} />}
		
		<!-- Article metadata -->
		<meta property="article:published_time" content={pubDate.toISOString()} />
		{updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
		<meta property="article:author" content={author} />
		{tags?.map((tag) => <meta property="article:tag" content={tag} />)}
		
		<!-- Canonical URL -->
		<link rel="canonical" href={canonicalURL} />
		
		<!-- Structured data -->
		<script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData)} />
	</Fragment>

	<article class="blog-post" transition:animate={fadeAnimation}>
		<div class="post-header-container">
			<header class="post-header">
				<div class="post-meta-header">
					<a href="/blog" class="back-link">← Back to Blog</a>
				</div>
				
				<h1>{title}</h1>
				
				<p class="post-description">{description}</p>
				
				<div class="post-meta">
					<span class="author">{author}</span>
					<time datetime={pubDate.toISOString()}>
						{pubDate.toLocaleDateString("en-US", {
							year: "numeric",
							month: "long",
							day: "numeric",
						})}
					</time>
					<span class="read-time" aria-label={`${readingTime} minute read`}>
						{readingTime} min read
					</span>
				</div>

				{tags && tags.length > 0 && (
					<div class="post-tags" role="list" aria-label="Post tags">
						{tags.map((tag) => (
							<BlogTag tag={tag} />
						))}
					</div>
				)}
			</header>
		</div>

		{heroImage && (
			<figure class="hero-image-figure">
				<div class="hero-image">
					<Picture
						src={heroImage}
						alt={heroImageAlt || title}
						formats={["avif", "webp"]}
						widths={[800, 1200, 1600, 2400]}
						sizes="100vw"
						loading="eager"
						fetchpriority="high"
						inferSize={true}
					/>
				</div>
				{heroImageCaption && (
					<figcaption class="hero-caption">{heroImageCaption}</figcaption>
				)}
			</figure>
		)}

		<div class="content-container">
			<div class="prose">
				<Content />
			</div>
		</div>
	</article>

	<AuthorBio 
		name="Peter Chr. Jørgensen"
		bio="Developer and writer exploring technology and Code. Building fast, accessible websites. I use AI to move faster, explore more ideas, and handle the parts of development that don't need a human touch."
	/>
</Layout>

<style lang="scss">
	@use "../../styles/variables" as *;
	@use "../../styles/mixins" as *;

	.blog-post {
		padding-top: $header-height;

		@include respond-to(md) {
			padding-top: calc($header-height - 20px);
		}
	}

	.post-header-container {
		max-width: $max-width;
		margin: 0 auto;
		padding: $space-4xl $space-xl $space-3xl;

		@include respond-to(md) {
			padding: $space-3xl $space-lg $space-2xl;
		}
	}

	.post-header {
		max-width: calc($max-width-text * 1.4);
		margin: 0 auto;
	}

	.post-meta-header {
		margin-bottom: $space-lg;
	}

	.back-link {
		color: $color-accent;
		text-decoration: none;
		font-size: $font-size-sm;
		@include transition(opacity);
		@include focus-visible;
	}

	.back-link:hover {
		opacity: 0.7;
	}

	.post-header h1 {
		font-size: 4.5rem;
		font-weight: $font-weight-bold;
		line-height: 1.1;
		margin: 0 0 $space-xl 0;
		color: $color-text-primary;

		@include respond-to(md) {
			font-size: $font-size-3xl;
		}
	}

	.post-description {
		font-size: $font-size-xl;
		line-height: 1.5;
		color: $color-text-secondary;
		margin: 0 0 $space-2xl 0;

		@include respond-to(md) {
			font-size: $font-size-lg;
		}
	}

	.post-meta {
		display: flex;
		flex-wrap: wrap;
		gap: $space-md;
		font-size: $font-size-sm;
		color: $color-text-secondary;
		align-items: center;

		&::before {
			content: '';
			display: block;
			width: 100%;
			height: 1px;
			background: $color-border;
			margin-bottom: $space-sm;
		}

		> * {
			display: flex;
			align-items: center;

			&:not(:last-child)::after {
				content: '•';
				margin-left: $space-md;
				color: $color-text-muted;
			}
		}
	}

	.post-tags {
		display: flex;
		flex-wrap: wrap;
		gap: $space-xs;
		margin-top: $space-lg;
	}

	.hero-image-figure {
		width: 100%;
		max-width: 1600px;
		margin: 0 auto;
	}

	.hero-image {
		width: 100%;
		aspect-ratio: 21 / 9;
		overflow: hidden;
		border-radius: 24px;

		@include respond-to(lg) {
			aspect-ratio: 16 / 9;
		}

		@include respond-to(md) {
			aspect-ratio: 3 / 2;
			border-radius: 16px;
		}

		:global(img) {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
	}

	.hero-caption {
		max-width: $max-width;
		margin: 0 auto;
		padding: $space-sm $space-xl 0;
		font-size: $font-size-sm;
		color: $color-text-muted;
		text-align: center;
		font-style: italic;

		@include respond-to(md) {
			padding: $space-xs $space-lg 0;
		}
	}

	.content-container {
		max-width: $max-width;
		margin: 0 auto;
		padding: $space-4xl $space-xl;

		@include respond-to(md) {
			padding: $space-3xl $space-lg;
		}
	}

	.prose {
		max-width: $max-width-text;
		margin: 0 auto;
		font-size: $font-size-lg;
		line-height: 1.75;
		color: $color-text-primary;

		@include respond-to(md) {
			font-size: $font-size-base;
		}
	}

	.prose :global(h2) {
		font-size: $font-size-2xl;
		font-weight: $font-weight-bold;
		margin-top: $space-4xl;
		margin-bottom: $space-lg;
		line-height: 1.3;
		color: $color-text-primary;

		@include respond-to(md) {
			font-size: $font-size-xl;
			margin-top: $space-3xl;
		}
	}

	.prose :global(h3) {
		font-size: $font-size-xl;
		font-weight: $font-weight-semibold;
		margin-top: $space-3xl;
		margin-bottom: $space-md;
		line-height: 1.3;
		color: $color-text-primary;

		@include respond-to(md) {
			font-size: $font-size-lg;
			margin-top: $space-2xl;
		}
	}

	.prose :global(h4) {
		font-size: $font-size-lg;
		font-weight: $font-weight-semibold;
		margin-top: $space-2xl;
		margin-bottom: $space-sm;
		color: $color-text-primary;
	}

	.prose :global(p) {
		margin-bottom: $space-xl;
		line-height: 1.75;
	}

	.prose :global(a) {
		color: $color-accent;
		text-decoration: underline;
		@include transition(opacity);
	}

	.prose :global(a:hover) {
		opacity: 0.7;
	}

	.prose :global(ul),
	.prose :global(ol) {
		margin-bottom: $space-xl;
		padding-left: $space-2xl;
	}

	.prose :global(li) {
		margin-bottom: $space-sm;
		line-height: 1.75;
	}

	.prose :global(code) {
		background: $color-cream;
		padding: 0.125rem 0.375rem;
		border-radius: 4px;
		font-size: 0.9em;
		font-family: ui-monospace, 'Courier New', monospace;
		color: $color-text-primary;
	}

	.prose :global(pre) {
		background: #1e1e1e;
		padding: $space-xl;
		border-radius: 16px;
		overflow-x: auto;
		margin: $space-2xl 0;
		border: 1px solid rgba(255, 255, 255, 0.1);
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

		@include respond-to(md) {
			padding: $space-lg;
			border-radius: 12px;
		}
	}

	.prose :global(pre code) {
		background: none;
		padding: 0;
		border-radius: 0;
		color: #d4d4d4;
		font-size: 0.9em;
		line-height: 1.6;
	}

	.prose :global(blockquote) {
		border-left: 4px solid $color-accent;
		padding-left: $space-xl;
		margin: $space-2xl 0;
		font-style: italic;
		color: $color-text-secondary;
	}

	// Wider images than text content
	.prose :global(img) {
		max-width: 120ch;
		width: calc(100% + 20rem);
		margin-left: -10rem;
		margin-right: -10rem;
		height: auto;
		border-radius: 24px;
		margin-top: $space-3xl;
		margin-bottom: $space-3xl;
		display: block;

		@include respond-to(md) {
			width: 100%;
			margin-left: 0;
			margin-right: 0;
			margin-top: $space-2xl;
			margin-bottom: $space-2xl;
			border-radius: 16px;
		}
	}

	.prose :global(figure) {
		max-width: 120ch;
		width: calc(100% + 20rem);
		margin-left: -10rem;
		margin-right: -10rem;
		margin-top: $space-3xl;
		margin-bottom: $space-3xl;

		@include respond-to(md) {
			width: 100%;
			margin-left: 0;
			margin-right: 0;
			margin-top: $space-2xl;
			margin-bottom: $space-2xl;
		}
	}

	.prose :global(figcaption) {
		max-width: $max-width;
		margin: 0 auto;
		padding: $space-lg $space-xl 0;
		font-size: $font-size-sm;
		color: $color-text-muted;
		text-align: center;
		font-style: italic;

		@include respond-to(md) {
			padding: $space-md $space-lg 0;
		}
	}
</style>
