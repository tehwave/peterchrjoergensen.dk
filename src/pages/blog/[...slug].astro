---
/**
 * Dynamic Blog Post Page
 *
 * Renders individual blog posts with full SEO optimization.
 * Supports both Markdown (.md) and MDX (.mdx) formats.
 *
 * Features:
 * - Full Open Graph and Twitter Card meta tags
 * - JSON-LD structured data for search engines
 * - Automatic table of contents generation from headings
 * - Hero image support with optimization
 * - Author and publication date metadata
 * - Tag display for categorization
 *
 * The [...slug] pattern creates a catch-all route that matches any blog post ID.
 */
import { getCollection, type CollectionEntry, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";

/**
 * Generate static paths for all blog posts at build time
 *
 * Astro calls this function during the build process to create
 * a static HTML file for each blog post.
 */
export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { slug: post.id }, // The URL slug (e.g., "welcome" for welcome.mdx)
		props: { post }, // Pass the full post data to the page
	}));
}

type Props = {
	post: CollectionEntry<"blog">;
};

const { post } = Astro.props;

// Render the Markdown/MDX content into HTML
// Content: The rendered component to display the post body
// headings: Array of h2-h6 headings for table of contents
const { Content, headings } = await render(post);

// Generate canonical URL for SEO
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Extract frontmatter data from the post
const { title, description, pubDate, updatedDate, author, tags, heroImage, heroImageAlt } = post.data;

/**
 * Generate JSON-LD structured data for search engines
 *
 * This helps Google and other search engines understand the content
 * and display rich results in search (author, date, etc.)
 *
 * @see https://schema.org/BlogPosting
 */
const articleSchema = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: title,
	description: description,
	author: {
		"@type": "Person",
		name: author,
	},
	datePublished: pubDate.toISOString(),
	// Add modification date if the post was updated
	...(updatedDate && { dateModified: updatedDate.toISOString() }),
	// Add hero image URL if one exists
	...(heroImage && {
		image: {
			"@type": "ImageObject",
			url: new URL(heroImage.src, Astro.site).toString(),
		},
	}),
};
---

<Layout 
	title={title} 
	description={description}
>
	<Fragment slot="head">
		<!-- 
			Social Media Meta Tags
			These control how the post appears when shared on social platforms
		-->
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="article" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		{heroImage && <meta property="og:image" content={new URL(heroImage.src, Astro.site)} />}
		
		<!-- Twitter -->
		<meta property="twitter:card" content={heroImage ? "summary_large_image" : "summary"} />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		{heroImage && <meta property="twitter:image" content={new URL(heroImage.src, Astro.site)} />}
		
		<!-- Article metadata -->
		<meta property="article:published_time" content={pubDate.toISOString()} />
		{updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
		<meta property="article:author" content={author} />
		{tags?.map((tag) => <meta property="article:tag" content={tag} />)}
		
		<!-- Canonical URL -->
		<link rel="canonical" href={canonicalURL} />
		
		<!-- Structured data -->
		<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
	</Fragment>

	<article class="blog-post">
		<header class="post-header">
			<div class="post-meta-header">
				<a href="/blog" class="back-link">‚Üê Back to Blog</a>
			</div>
			
			<h1>{title}</h1>
			
			<div class="post-meta">
				<time datetime={pubDate.toISOString()}>
					{pubDate.toLocaleDateString("en-US", {
						year: "numeric",
						month: "long",
						day: "numeric",
					})}
				</time>
				{updatedDate && (
					<span class="updated">
						(Updated: {updatedDate.toLocaleDateString("en-US", {
							year: "numeric",
							month: "long",
							day: "numeric",
						})})
					</span>
				)}
				<span class="author">by {author}</span>
			</div>

			{tags && tags.length > 0 && (
				<div class="tags">
					{tags.map((tag) => (
						<span class="tag">{tag}</span>
					))}
				</div>
			)}
		</header>

		{heroImage && (
			<div class="hero-image">
				<Image
					src={heroImage}
					alt={heroImageAlt || title}
					width={1200}
					height={630}
					loading="eager"
					decoding="async"
				/>
			</div>
		)}

		<div class="prose">
			<Content />
		</div>

		{headings.length > 0 && (
			<aside class="table-of-contents">
				<h2>Table of Contents</h2>
				<nav>
					<ul>
						{headings.map((heading) => (
							<li class={`toc-level-${heading.depth}`}>
								<a href={`#${heading.slug}`}>{heading.text}</a>
							</li>
						))}
					</ul>
				</nav>
			</aside>
		)}
	</article>
</Layout>

<style>
	.blog-post {
		max-width: 800px;
		margin: 0 auto;
		padding: 2rem 1rem;
		padding-top: 120px;

		@media (max-width: 768px) {
			padding-top: 100px;
		}
	}

	.post-header {
		margin-bottom: 2rem;
	}

	.post-meta-header {
		margin-bottom: 1rem;
	}

	.back-link {
		color: var(--accent, #0066cc);
		text-decoration: none;
		font-size: 0.875rem;
		transition: opacity 0.2s ease;
	}

	.back-link:hover {
		opacity: 0.7;
	}

	.post-header h1 {
		font-size: 2.5rem;
		line-height: 1.2;
		margin-bottom: 1rem;
	}

	.post-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		font-size: 0.875rem;
		color: var(--text-secondary, #666);
		margin-bottom: 1rem;
	}

	.updated {
		font-style: italic;
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-top: 1rem;
	}

	.tag {
		display: inline-block;
		padding: 0.25rem 0.75rem;
		background: var(--accent-light, #e3f2fd);
		color: var(--accent, #0066cc);
		border-radius: 4px;
		font-size: 0.875rem;
		font-weight: 500;
	}

	.hero-image {
		margin: 2rem 0;
		border-radius: 8px;
		overflow: hidden;
	}

	.hero-image img {
		width: 100%;
		height: auto;
		display: block;
	}

	.prose {
		font-size: 1.125rem;
		line-height: 1.75;
		color: var(--text-primary, #333);
	}

	.prose :global(h2) {
		font-size: 2rem;
		margin-top: 2.5rem;
		margin-bottom: 1rem;
		line-height: 1.3;
	}

	.prose :global(h3) {
		font-size: 1.5rem;
		margin-top: 2rem;
		margin-bottom: 0.75rem;
		line-height: 1.3;
	}

	.prose :global(h4) {
		font-size: 1.25rem;
		margin-top: 1.5rem;
		margin-bottom: 0.5rem;
	}

	.prose :global(p) {
		margin-bottom: 1.5rem;
	}

	.prose :global(a) {
		color: var(--accent, #0066cc);
		text-decoration: underline;
	}

	.prose :global(a:hover) {
		opacity: 0.7;
	}

	.prose :global(ul),
	.prose :global(ol) {
		margin-bottom: 1.5rem;
		padding-left: 2rem;
	}

	.prose :global(li) {
		margin-bottom: 0.5rem;
	}

	.prose :global(code) {
		background: var(--surface-secondary, #f5f5f5);
		padding: 0.125rem 0.375rem;
		border-radius: 4px;
		font-size: 0.9em;
		font-family: "Courier New", monospace;
	}

	.prose :global(pre) {
		background: var(--surface-secondary, #f5f5f5);
		padding: 1rem;
		border-radius: 8px;
		overflow-x: auto;
		margin-bottom: 1.5rem;
	}

	.prose :global(pre code) {
		background: none;
		padding: 0;
	}

	.prose :global(blockquote) {
		border-left: 4px solid var(--accent, #0066cc);
		padding-left: 1.5rem;
		margin: 1.5rem 0;
		font-style: italic;
		color: var(--text-secondary, #666);
	}

	.prose :global(img) {
		max-width: 100%;
		height: auto;
		border-radius: 8px;
		margin: 1.5rem 0;
	}

	.table-of-contents {
		margin-top: 3rem;
		padding: 1.5rem;
		background: var(--surface-secondary, #f5f5f5);
		border-radius: 8px;
	}

	.table-of-contents h2 {
		font-size: 1.25rem;
		margin-bottom: 1rem;
	}

	.table-of-contents ul {
		list-style: none;
		padding: 0;
	}

	.table-of-contents li {
		margin-bottom: 0.5rem;
	}

	.table-of-contents a {
		color: var(--text-primary, #333);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.table-of-contents a:hover {
		color: var(--accent, #0066cc);
	}

	.toc-level-3 {
		margin-left: 1rem;
	}

	.toc-level-4 {
		margin-left: 2rem;
	}

	@media (max-width: 768px) {
		.post-header h1 {
			font-size: 2rem;
		}

		.prose {
			font-size: 1rem;
		}

		.prose :global(h2) {
			font-size: 1.5rem;
		}

		.prose :global(h3) {
			font-size: 1.25rem;
		}
	}
</style>
