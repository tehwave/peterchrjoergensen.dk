---
/**
 * Blog Index Page — "The Journal"
 *
 * Newspaper-style blog listing with minimal design:
 * - Single-column centered layout
 * - Date + reading time, title, description, tags
 * - Horizontal dividers between posts
 * - No hero images (kept for individual post pages only)
 *
 * Posts are sorted by publication date (newest first).
 */
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import AnimateOnScroll from "../../components/AnimateOnScroll.astro";
import BlogPostCard from "../../components/BlogPostCard.astro";
import { getReadingTime } from "../../utils/reading-time";

type Props = Record<string, never>;

// Fetch all blog posts from the content collection
const posts = await getCollection("blog");

// Sort posts by publication date, newest first
const sortedPosts = posts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Prepare posts with reading time
const postsWithReadingTime = sortedPosts.map((post) => ({
	...post,
	readingTime: getReadingTime(post.body ?? ""),
}));

// SEO metadata
const title = "The Journal";
const description = "I write about web development, performance optimization, and building with Astro. Technical articles and thoughts on modern web development.";

// Custom view transition: fade out down → fade in up
const customFadeAnimation = {
	forwards: {
		old: [
			{
				name: "fadeOutDown",
				duration: "0.3s",
				easing: "ease-in",
				fillMode: "forwards",
			},
		],
		new: [
			{
				name: "fadeInUp",
				duration: "0.4s",
				easing: "ease-out",
				fillMode: "backwards",
				delay: "0.3s",
			},
		],
	},
	backwards: {
		old: [
			{
				name: "fadeOutDown",
				duration: "0.3s",
				easing: "ease-in",
				fillMode: "forwards",
			},
		],
		new: [
			{
				name: "fadeInUp",
				duration: "0.4s",
				easing: "ease-out",
				fillMode: "backwards",
				delay: "0.3s",
			},
		],
	},
};

// Structured data for blog listing page
const collectionSchema = {
	"@context": "https://schema.org",
	"@graph": [
		{
			"@type": "CollectionPage",
			"@id": "https://peterchrjoergensen.dk/blog#collection",
			url: "https://peterchrjoergensen.dk/blog",
			name: title,
			description: description,
			inLanguage: "en-US",
			isPartOf: {
				"@id": "https://peterchrjoergensen.dk/#website",
			},
			mainEntity: {
				"@id": "https://peterchrjoergensen.dk/blog#itemlist",
			},
		},
		{
			"@type": "ItemList",
			"@id": "https://peterchrjoergensen.dk/blog#itemlist",
			itemListElement: postsWithReadingTime.map((post, index) => ({
				"@type": "ListItem",
				position: index + 1,
				url: `https://peterchrjoergensen.dk/blog/${post.id}`,
				name: post.data.title,
			})),
		},
		{
			"@type": "BreadcrumbList",
			itemListElement: [
				{
					"@type": "ListItem",
					position: 1,
					name: "Home",
					item: "https://peterchrjoergensen.dk",
				},
				{
					"@type": "ListItem",
					position: 2,
					name: "Blog",
					item: "https://peterchrjoergensen.dk/blog",
				},
			],
		},
	],
};
---

<Layout title={title} description={description}>
	<Fragment slot="head">
		<!-- Structured data for blog collection -->
		<script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
	</Fragment>
	<main class="journal" transition:animate={customFadeAnimation}>
		<div class="journal__container">
			<header class="journal__header">
				<div class="journal__header-left">
					<span class="journal__label">MY WRITING</span>
					<h1 class="journal__title">The Journal</h1>
				</div>
				<p class="journal__tagline">{description}</p>
			</header>

			{
				postsWithReadingTime.length === 0 ? (
					<p class="journal__empty">No posts yet. Check back soon!</p>
				) : (
					<div class="journal__list">
						{postsWithReadingTime.map((post, index) => (
							<AnimateOnScroll animation="fade-up" delay={index * 80}>
								<article class="post">
									<div class="post__meta">
										<time datetime={post.data.pubDate.toISOString()}>
											{post.data.pubDate.toLocaleDateString("en-US", {
												year: "numeric",
												month: "long",
												day: "numeric",
											})}
										</time>
										<span class="post__separator" aria-hidden="true" />
									<span class="post__reading-time" aria-label={`${post.readingTime} minute read`}>
											{post.readingTime} min read
										</span>
									</div>

									<a href={`/blog/${post.id}`} class="post__link">
										<h2 class="post__title">{post.data.title}</h2>
									</a>

									<p class="post__description">{post.data.description}</p>

									{post.data.tags && post.data.tags.length > 0 && (
										<div class="post__tags">
											{post.data.tags.map((tag) => (
												<span class="post__tag">{tag}</span>
											))}
										</div>
									)}
								</article>
							</AnimateOnScroll>
						))}
					</div>
				)
			}
		</div>
	</main>
</Layout>

<style lang="scss">
	@use "../../styles/variables" as *;
	@use "../../styles/mixins" as *;

	.journal {
		position: relative;
		padding: $space-4xl $space-xl;
		padding-top: calc($space-4xl + 100px);

		@include respond-to(md) {
			padding: $space-3xl $space-lg;
			padding-top: calc($space-3xl + 80px);
		}

		&__container {
			position: relative;
			z-index: 1;
			max-width: $max-width;
			margin: 0 auto;
		}

		&__header {
			display: grid;
			grid-template-columns: 1fr 1.5fr;
			gap: $space-4xl;
			margin-bottom: $space-3xl;
			padding-bottom: $space-2xl;
			border-bottom: 1px solid $color-border;

			@include respond-to(lg) {
				grid-template-columns: 1fr;
				gap: $space-xl;
			}
		}

		&__header-left {
			display: flex;
			flex-direction: column;
			gap: $space-md;
		}

		&__label {
			color: $color-orange;
			font-size: $font-size-sm;
			font-weight: 600;
			letter-spacing: 0.1em;
			text-transform: uppercase;
		}

		&__title {
			font-size: clamp($font-size-2xl, 4vw, $font-size-3xl);
			font-weight: $font-weight-bold;
			color: $color-text-dark;
			line-height: $leading-tight;
		}

		&__tagline {
			font-size: $font-size-lg;
			color: $color-text-muted;
			line-height: $leading-relaxed;
			align-self: center;

			@include respond-to(lg) {
				align-self: flex-start;
			}
		}

		&__empty {
			text-align: center;
			font-size: $font-size-lg;
			color: $color-text-muted;
			padding: $space-3xl 0;
		}

		&__list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
			gap: $space-2xl;

			@include respond-to(md) {
				grid-template-columns: 1fr;
				gap: $space-xl;
			}
		}
	}

	.post {
		padding: $space-xl;
		background: $color-bg-alt;
		border-radius: 12px;
		border: 1px solid $color-border;
		height: 100%;
		display: flex;
		flex-direction: column;
		@include transition(box-shadow, border-color);

		&:hover {
			border-color: $color-orange;
			box-shadow: 0 4px 20px $color-shadow;
		}

		&__meta {
			display: flex;
			align-items: center;
			gap: $space-sm;
			font-size: $font-size-sm;
			color: $color-text-muted;
			margin-bottom: $space-md;

			time {
				color: $color-text-muted;
			}
		}

		&__separator {
			display: inline-block;
			width: 3px;
			height: 3px;
			border-radius: 50%;
			background: $color-text-muted;
		}

		&__reading-time {
			color: $color-text-muted;
		}

		&__title {
			font-size: $font-size-xl;
			font-weight: $font-weight-semibold;
			line-height: $leading-snug;
			margin-bottom: $space-sm;
		}

		&__link {
			text-decoration: none;
			color: $color-text-dark;
			display: inline;
			@include transition(color);
			@include focus-visible;

			&:hover {
				color: $color-orange;
			}
		}

		&__description {
			font-size: $font-size-base;
			color: $color-text-muted;
			line-height: $leading-relaxed;
			margin-bottom: $space-md;
			flex-grow: 1;
		}

		&__tags {
			display: flex;
			gap: $space-sm;
			flex-wrap: wrap;
			margin-top: auto;
		}

		&__tag {
			display: inline-block;
			padding: $space-xs $space-sm;
			background: rgba($color-orange, 0.1);
			color: $color-orange;
			font-size: $font-size-xs;
			font-weight: $font-weight-medium;
			text-transform: lowercase;
			letter-spacing: $tracking-wide;
			border-radius: 4px;
		}
	}
</style>
