---
/**
 * Dynamic Project Page
 *
 * Renders individual project case studies with full SEO optimization.
 * Only projects in src/content/projects/ with MDX body content get pages.
 *
 * Features:
 * - Full Open Graph and Twitter Card meta tags
 * - JSON-LD structured data (CreativeWork schema)
 * - Hero image support with optimization
 * - Tag display for technologies used
 * - Optional external project link
 *
 * The [...slug] pattern creates a catch-all route for each project.
 */
import { getCollection, type CollectionEntry, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Picture } from "astro:assets";
import SkillTag from "../../components/SkillTag.astro";
import { fadeAnimation } from "../../utils/transitions";
import { parseInlineMarkdown } from "../../utils/markdown";

/**
 * Generate static paths for all projects at build time
 *
 * Astro calls this function during the build process to create
 * a static HTML file for each project with MDX content.
 */
export async function getStaticPaths() {
  const projects = await getCollection("projects");

  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

type Props = {
  project: CollectionEntry<"projects">;
};

const { project } = Astro.props;

// Render the MDX content into HTML
const { Content } = await render(project);

// Generate canonical URL for SEO
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Extract frontmatter data from the project
const {
  title,
  description,
  category,
  tags,
  externalUrl,
  heroImage,
  heroImageAlt,
  heroImageCaption,
  ogDescription,
} = project.data;

// Use ogDescription if provided, otherwise fall back to description
const socialDescription = ogDescription || description;

/**
 * Generate JSON-LD structured data for search engines
 *
 * Uses CreativeWork schema for project case studies
 *
 * @see https://schema.org/CreativeWork
 * @see https://schema.org/BreadcrumbList
 */
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CreativeWork",
      "@id": canonicalURL + "#project",
      name: title,
      description: description,
      url: canonicalURL.toString(),
      author: {
        "@type": "Person",
        "@id": "https://peterchrjoergensen.dk/#person",
        name: "Peter Chr. Jørgensen",
      },
      creator: {
        "@type": "Person",
        "@id": "https://peterchrjoergensen.dk/#person",
        name: "Peter Chr. Jørgensen",
      },
      inLanguage: "en-US",
      keywords: tags?.join(", ") || "",
      genre: category,
      ...(heroImage && {
        image: {
          "@type": "ImageObject",
          url: new URL(heroImage.src, Astro.site).toString(),
          width: heroImage.width,
          height: heroImage.height,
        },
        thumbnailUrl: new URL(heroImage.src, Astro.site).toString(),
      }),
    },
    {
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: "https://peterchrjoergensen.dk/",
        },
        {
          "@type": "ListItem",
          position: 2,
          name: "Projects",
          item: "https://peterchrjoergensen.dk/#projects",
        },
        {
          "@type": "ListItem",
          position: 3,
          name: title,
          item: canonicalURL.toString(),
        },
      ],
    },
  ],
};
---

<Layout
  title={`${title} | Peter Chr. Jørgensen`}
  description={socialDescription}
>
  <Fragment slot="head">
    <!-- 
			Social Media Meta Tags
			These control how the project appears when shared on social platforms
		-->

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={socialDescription} />
    {
      heroImage && (
        <meta
          property="og:image"
          content={new URL(heroImage.src, Astro.site)}
        />
      )
    }

    <!-- Twitter -->
    <meta
      property="twitter:card"
      content={heroImage ? "summary_large_image" : "summary"}
    />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={socialDescription} />
    {
      heroImage && (
        <meta
          property="twitter:image"
          content={new URL(heroImage.src, Astro.site)}
        />
      )
    }

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Structured data -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />
  </Fragment>

  <article class="project-page" transition:animate={fadeAnimation}>
    <div class="project-page__header-container">
      <header class="project-page__header">
        <div class="project-page__meta-header">
          <a href="/#projects" class="project-page__back-link"
            >← Back to Projects</a
          >
        </div>

        <h1>{title}</h1>

        <p class="project-page__description">{description}</p>

        <div class="project-page__meta">
          <span class="project-page__category" data-category={category}>
            {category.charAt(0).toUpperCase() + category.slice(1)}
          </span>
          {
            externalUrl && (
              <a
                href={externalUrl}
                class="project-page__external-link"
                target="_blank"
                rel="noopener noreferrer"
              >
                Visit Project
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                  <polyline points="15 3 21 3 21 9" />
                  <line x1="10" y1="14" x2="21" y2="3" />
                </svg>
              </a>
            )
          }
        </div>

        {
          tags && tags.length > 0 && (
            <div
              class="project-page__tags"
              role="list"
              aria-label="Technologies used"
            >
              {tags.map((tag: string) => (
                <SkillTag label={tag} />
              ))}
            </div>
          )
        }
      </header>
    </div>

    {
      heroImage && (
        <figure class="project-page__hero-figure">
          <div class="project-page__hero">
            <Picture
              src={heroImage}
              alt={heroImageAlt || title}
              formats={["avif", "webp"]}
              widths={[800, 1200, 1600, 2400]}
              sizes="100vw"
              loading="eager"
              fetchpriority="high"
              inferSize={true}
            />
          </div>
          {heroImageCaption && (
            <figcaption
              class="project-page__hero-caption"
              set:html={parseInlineMarkdown(heroImageCaption)}
            />
          )}
        </figure>
      )
    }

    <div class="project-page__content">
      <div class="project-page__prose">
        <Content />
      </div>
    </div>
  </article>
</Layout>

<script>
  /**
   * Simple parallax effect for project hero image
   * Adapted from blog post parallax effect
   */
  function initParallax() {
    const hero = document.querySelector(".project-page__hero") as HTMLElement;

    // Early return if hero image doesn't exist on this page
    if (!hero) return;

    // Respect user's motion preferences (WCAG 2.3.3)
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;

    if (prefersReducedMotion) return;

    function handleParallax() {
      const scrollY = window.scrollY;
      const heroBottom = hero.offsetTop + hero.offsetHeight;

      // Only apply parallax while hero is visible
      if (scrollY < heroBottom) {
        // Subtle parallax - reduced on mobile for better performance
        const isMobile = window.matchMedia("(max-width: 1023px)").matches;
        const parallaxFactor = isMobile ? 0.015 : 0.05;
        const parallaxOffset = scrollY * parallaxFactor;
        // Reverse parallax - image moves up as you scroll down
        hero.style.transform = `translateY(-${parallaxOffset}px)`;
      }
    }

    // Attach scroll listener with passive flag for better performance
    window.addEventListener("scroll", handleParallax, { passive: true });

    // Cleanup function for view transitions
    const cleanup = () => {
      window.removeEventListener("scroll", handleParallax);
      // Reset transform on cleanup
      if (hero) {
        hero.style.transform = "";
      }
    };

    // Register cleanup before navigation
    document.addEventListener("astro:before-preparation", cleanup, {
      once: true,
    });
  }

  // Run on initial page load
  initParallax();

  // Re-initialize after view transitions
  document.addEventListener("astro:page-load", initParallax);
</script>

<style lang="scss">
  @use "../../styles/variables" as *;
  @use "../../styles/mixins" as *;

  .project-page {
    padding-top: $header-height;

    @include respond-to(md) {
      padding-top: calc($header-height - 20px);
    }

    &__header-container {
      width: 100%;
      max-width: $max-width;
      margin: 0 auto;
      padding: $space-4xl $space-xl $space-3xl;

      @include respond-to(md) {
        padding: $space-3xl $space-lg $space-2xl;
      }
    }

    &__header {
      max-width: calc($max-width-text * 1.4);
      margin: 0 auto;

      h1 {
        font-size: 4.5rem;
        font-weight: $font-weight-bold;
        line-height: 1.1;
        margin: 0 0 $space-xl 0;
        color: $color-text-primary;

        @include respond-to(md) {
          font-size: $font-size-3xl;
        }
      }
    }

    &__meta-header {
      margin-bottom: $space-lg;
    }

    &__back-link {
      display: block;
      color: $color-orange;
      font-size: $font-size-sm;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: $space-md;
      text-decoration: none;
      @include transition(opacity);
      @include focus-visible;

      &:hover {
        opacity: 0.7;
      }
    }

    &__description {
      font-size: $font-size-xl;
      line-height: 1.5;
      color: $color-text-secondary;
      margin: 0 0 $space-2xl 0;

      @include respond-to(md) {
        font-size: $font-size-lg;
      }
    }

    &__meta {
      display: flex;
      flex-wrap: wrap;
      gap: $space-md;
      font-size: $font-size-sm;
      color: $color-text-secondary;
      align-items: center;

      &::before {
        content: "";
        display: block;
        width: 100%;
        height: 1px;
        background: $color-border;
        margin-bottom: $space-sm;
      }
    }

    &__category {
      padding: $space-xs $space-md;
      border-radius: 20px;
      background: $color-cream;
      color: $color-text-dark;
      font-weight: $font-weight-semibold;
      text-transform: capitalize;

      &[data-category="web"] {
        background: rgba(59, 130, 246, 0.1);
        color: rgb(59, 130, 246);
      }

      &[data-category="games"] {
        background: rgba(168, 85, 247, 0.1);
        color: rgb(168, 85, 247);
      }

      &[data-category="creative"] {
        background: rgba(236, 72, 153, 0.1);
        color: rgb(236, 72, 153);
      }
    }

    &__external-link {
      display: inline-flex;
      align-items: center;
      gap: $space-xs;
      color: $color-orange;
      text-decoration: none;
      font-weight: $font-weight-semibold;
      @include transition(all, 0.2s);

      &:hover,
      &:focus {
        color: $color-orange-dark;
        gap: $space-sm;
      }

      svg {
        flex-shrink: 0;
      }
    }

    &__tags {
      display: flex;
      flex-wrap: wrap;
      gap: $space-xs;
      margin-top: $space-lg;
    }

    &__hero-figure {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 $space-xl;

      @include respond-to(md) {
        padding: 0 $space-lg;
      }
    }

    &__hero {
      width: 100%;
      aspect-ratio: 21 / 9;
      overflow: hidden;
      border-radius: 24px;
      will-change: transform;

      @media (prefers-reduced-motion: no-preference) {
        transition: transform 0.1s ease-out;
      }

      @include respond-to(lg) {
        aspect-ratio: 16 / 9;
      }

      @include respond-to(md) {
        aspect-ratio: 3 / 2;
        border-radius: 16px;
      }

      :global(img) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
    }

    &__hero-caption {
      max-width: $max-width;
      margin: 0 auto;
      padding: $space-sm $space-xl 0;
      font-size: $font-size-sm;
      color: $color-text-muted;
      text-align: center;
      font-style: italic;

      @include respond-to(md) {
        padding: $space-xs $space-lg 0;
      }
    }

    &__content {
      max-width: $max-width;
      margin: 0 auto;
      padding: $space-4xl $space-xl;

      @include respond-to(md) {
        padding: $space-3xl $space-lg;
      }
    }

    &__prose {
      max-width: $max-width-text;
      margin: 0 auto;
      font-size: $font-size-lg;
      line-height: 1.75;
      color: $color-text-primary;

      @include respond-to(md) {
        font-size: $font-size-base;
      }

      // Typography
      :global(h2),
      :global(h3),
      :global(h4) {
        font-weight: $font-weight-bold;
        line-height: 1.3;
        color: $color-text-primary;
      }

      :global(h2) {
        font-size: $font-size-2xl;
        margin-top: $space-4xl;
        margin-bottom: $space-lg;

        @include respond-to(md) {
          font-size: $font-size-xl;
          margin-top: $space-3xl;
        }
      }

      :global(h3) {
        font-size: $font-size-xl;
        font-weight: $font-weight-semibold;
        margin-top: $space-3xl;
        margin-bottom: $space-md;

        @include respond-to(md) {
          font-size: $font-size-lg;
          margin-top: $space-2xl;
        }
      }

      :global(h4) {
        font-size: $font-size-lg;
        font-weight: $font-weight-semibold;
        margin-top: $space-2xl;
        margin-bottom: $space-sm;
      }

      :global(p) {
        margin-bottom: $space-xl;
      }

      // Links
      :global(a) {
        color: $color-accent;
        text-decoration: underline;
        @include transition(opacity);

        &:hover {
          opacity: 0.7;
        }
      }

      // Lists
      :global(ul),
      :global(ol) {
        margin-bottom: $space-xl;
        padding-left: $space-2xl;
      }

      :global(li) {
        margin-bottom: $space-sm;
      }

      // Code
      :global(code) {
        background: $color-cream;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: ui-monospace, "Courier New", monospace;
        color: $color-text-primary;
        font-weight: 600;
      }

      :global(pre) {
        background: $color-code-bg;
        padding: $space-xl;
        border-radius: 16px;
        overflow-x: auto;
        margin: $space-2xl 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

        @include respond-to(md) {
          padding: $space-lg;
          border-radius: 12px;
        }

        :global(code) {
          background: none;
          padding: 0;
          border-radius: 0;
          color: $color-code-text;
          line-height: 1.6;
        }
      }

      // Blockquotes
      :global(blockquote) {
        border-left: 4px solid $color-accent;
        padding-left: $space-xl;
        margin: $space-2xl 0;
        font-style: italic;
        color: $color-text-secondary;
      }

      // Images and figures - wider than text content
      :global(img),
      :global(figure) {
        max-width: 120ch;
        margin-block: $space-3xl;

        @media (min-width: 1600px) {
          width: calc(100% + 16rem);
          margin-inline: -8rem;
        }

        @media (min-width: 1200px) and (max-width: 1599px) {
          width: calc(100% + 8rem);
          margin-inline: -4rem;
        }

        @include respond-to(lg) {
          width: 100%;
          margin-inline: 0;
          margin-block: $space-2xl;
        }
      }

      :global(img) {
        height: auto;
        display: block;
        border-radius: 24px;

        @include respond-to(md) {
          border-radius: 16px;
        }
      }

      :global(figcaption) {
        max-width: $max-width;
        margin: 0 auto;
        padding: $space-lg $space-xl 0;
        font-size: $font-size-sm;
        color: $color-text-muted;
        text-align: center;
        font-style: italic;

        @include respond-to(md) {
          padding: $space-md $space-lg 0;
        }
      }
    }
  }
</style>
