---
/**
 * AnimateOnScroll Component
 *
 * Wraps content in a container that animates when scrolled into view.
 * Uses Intersection Observer for performance-friendly scroll detection.
 * Respects prefers-reduced-motion automatically via CSS.
 *
 * @example
 * <AnimateOnScroll>
 *   <h2>This will fade in when scrolled into view</h2>
 * </AnimateOnScroll>
 *
 * @example With delay
 * <AnimateOnScroll delay={0.2}>
 *   <p>This will animate with a 200ms delay</p>
 * </AnimateOnScroll>
 *
 * @example With custom animation
 * <AnimateOnScroll animation="fade">
 *   <div>Fade only, no movement</div>
 * </AnimateOnScroll>
 */

interface Props {
  /** Animation delay in seconds */
  delay?: number;
  /** Animation type: 'fade-up' (default), 'fade', or 'scale' */
  animation?: "fade-up" | "fade" | "scale";
  /** Intersection threshold (0-1) - how much of element must be visible */
  threshold?: number;
  /** Custom class to add to wrapper */
  class?: string;
  /** HTML tag to use for wrapper */
  as?: "div" | "section" | "article" | "aside" | "span";
}

const { delay = 0, animation = "fade-up", threshold = 0.1, class: className = "", as: Tag = "div" }: Props = Astro.props;
---

<Tag class:list={["animate-on-scroll", `animate-on-scroll--${animation}`, className]} data-aos-threshold={threshold} style={delay > 0 ? `--aos-delay: ${delay}s` : undefined}>
  <slot />
</Tag>

<style lang="scss">
  @use "../styles/mixins" as *;

  .animate-on-scroll {
    // Modern browsers: scroll-driven animations (no JavaScript needed)
    @supports (animation-timeline: view()) {
      // Fade up animation (default)
      &--fade-up {
        animation: fade-up-scroll linear both;
        animation-timeline: view();
        animation-range: entry 0% cover 30%;
      }

      // Fade only animation
      &--fade {
        animation: fade-scroll linear both;
        animation-timeline: view();
        animation-range: entry 0% cover 30%;
      }

      // Scale animation
      &--scale {
        animation: scale-scroll linear both;
        animation-timeline: view();
        animation-range: entry 0% cover 30%;
      }
    }

    // Fallback for older browsers: Intersection Observer + CSS transitions
    @supports not (animation-timeline: view()) {
      &--fade-up {
        opacity: 0;
        transform: translateY(80px);

        &.is-visible {
          opacity: 1;
          transform: translateY(0);
          transition:
            opacity var(--duration-slow, 0.6s) var(--ease-out, ease-out),
            transform var(--duration-slow, 0.6s) var(--ease-out, ease-out);
          transition-delay: var(--aos-delay, 0s);
        }
      }

      &--fade {
        opacity: 0;

        &.is-visible {
          opacity: 1;
          transition: opacity var(--duration-slow, 0.6s) var(--ease-out, ease-out);
          transition-delay: var(--aos-delay, 0s);
        }
      }

      &--scale {
        opacity: 0;
        transform: scale(0.95);

        &.is-visible {
          opacity: 1;
          transform: scale(1);
          transition:
            opacity var(--duration-slow, 0.6s) var(--ease-out, ease-out),
            transform var(--duration-slow, 0.6s) var(--ease-out-back, ease-out);
          transition-delay: var(--aos-delay, 0s);
        }
      }
    }

    // Respect reduced motion preference
    @include reduced-motion {
      opacity: 1 !important;
      transform: none !important;
      transition: none !important;
      animation: none !important;
    }
  }

  // Keyframes for scroll-driven animations
  @keyframes fade-up-scroll {
    from {
      opacity: 0;
      transform: translateY(80px);
    }
    75% {
      opacity: 1;
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fade-scroll {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes scale-scroll {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>
  // Fallback for browsers without scroll-driven animations support
  // Modern browsers use pure CSS with animation-timeline: view()

  function initAnimateOnScroll() {
    // Skip if browser supports scroll-driven animations
    if (CSS.supports("animation-timeline", "view()")) {
      return;
    }

    const elements = document.querySelectorAll(".animate-on-scroll:not(.is-visible)");

    if (!elements.length) return;

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (prefersReducedMotion) {
      elements.forEach((el) => el.classList.add("is-visible"));
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
            observer.unobserve(entry.target);
          }
        });
      },
      {
        root: null,
        rootMargin: "0px 0px 20% 0px",
        threshold: 0,
      },
    );

    elements.forEach((el) => observer.observe(el));
  }

  // Store handler to prevent duplicates
  let animateHandler: (() => void) | null = null;

  const ensureAnimateHandler = () => {
    if (animateHandler) {
      document.removeEventListener("astro:page-load", animateHandler);
    }
    animateHandler = initAnimateOnScroll;
    document.addEventListener("astro:page-load", animateHandler);
  };

  // Initialize
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initAnimateOnScroll();
      ensureAnimateHandler();
    });
  } else {
    initAnimateOnScroll();
    ensureAnimateHandler();
  }
</script>
