---
/**
 * Sticky header with scroll-aware styling.
 *
 * Transforms from transparent to solid background after scrolling past hero,
 * with smooth enter/exit animations. Active nav link updates based on current
 * scroll position to provide orientation on long pages.
 */
type Props = Record<string, never>;
---

<header class="header">
  <div class="header__container">
    <a href="/" class="header__logo">Peter Chr. JÃ¸rgensen</a>
    <nav class="header__nav" aria-label="Main navigation">
      <a href="/#projects" class="header__nav-link">Projects</a>
      <a href="/#ai" class="header__nav-link">AI</a>
      <a href="/#blog" class="header__nav-link">Blog</a>
    </nav>
  </div>
</header>

<script>
  class HeaderManager {
    private header: HTMLElement | null;
    private hero: HTMLElement | null;
    private navLinks: NodeListOf<Element>;
    private sections: NodeListOf<Element>;
    private isHomepage: boolean;
    private wasScrolled = false;
    private isAnimatingOut = false;

    constructor() {
      this.header = document.querySelector(".header");
      this.hero = document.querySelector("#hero");
      this.navLinks = document.querySelectorAll(".header__nav-link");
      this.sections = document.querySelectorAll("section[id], footer[id]");
      this.isHomepage = this.hero !== null;

      // Immediately clean up classes on non-homepage to prevent animations
      if (!this.isHomepage && this.header) {
        this.header.classList.remove("scrolled", "scrolled-exit");
        this.header.classList.add("scrolled-no-animation");
      }
    }

    private handleScrolledState(): void {
      if (!this.header || !this.hero || !this.isHomepage) return;

      const heroBottom = this.hero.offsetTop + this.hero.offsetHeight;
      const isScrolledPastHero = window.scrollY > heroBottom;

      if (isScrolledPastHero && !this.isAnimatingOut) {
        this.showScrolledHeader();
      } else if (!isScrolledPastHero && this.wasScrolled && !this.isAnimatingOut) {
        this.hideScrolledHeader();
      }
    }

    private showScrolledHeader(): void {
      if (!this.header) return;
      this.header.classList.remove("scrolled-exit");
      this.header.classList.add("scrolled");
      this.wasScrolled = true;
    }

    private hideScrolledHeader(): void {
      if (!this.header) return;
      this.isAnimatingOut = true;
      this.header.classList.add("scrolled-exit");

      setTimeout(() => {
        this.header?.classList.remove("scrolled", "scrolled-exit");
        this.wasScrolled = false;
        this.isAnimatingOut = false;
      }, 300);
    }

    private handleNonHomepageState(): void {
      if (!this.header || this.isHomepage) return;

      // Always use no-animation class for non-homepage pages to prevent fade-in on view transitions
      this.header.classList.remove("scrolled", "scrolled-exit");
      this.header.classList.add("scrolled-no-animation");

      // Add shadow only if scrolled down
      this.updateShadow();
    }

    private updateShadow(): void {
      if (!this.header) return;

      // Add shadow if scrolled more than 20px from top
      const shouldHaveShadow = window.scrollY > 20;
      this.header.classList.toggle("has-shadow", shouldHaveShadow);
    }

    private updateActiveLink(): void {
      const currentSection = this.getCurrentSection();

      this.navLinks.forEach((link) => {
        const href = link.getAttribute("href");
        const isActive = href === `#${currentSection}` || href === `/#${currentSection}`;
        link.classList.toggle("active", isActive);
      });
    }

    private getCurrentSection(): string {
      const scrollPosition = window.scrollY + window.innerHeight / 3;

      for (const section of Array.from(this.sections)) {
        const el = section as HTMLElement;
        const sectionTop = el.offsetTop;
        const sectionHeight = el.offsetHeight;

        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          return el.getAttribute("id") || "";
        }
      }

      return "";
    }

    private handleScroll = (): void => {
      if (!this.header) return;

      this.handleNonHomepageState();
      this.handleScrolledState();
      this.updateActiveLink();
      this.updateShadow();
    };

    public init(): () => void {
      if (this.header) {
        window.addEventListener("scroll", this.handleScroll);
        // Use requestAnimationFrame to avoid triggering on initial load
        requestAnimationFrame(() => this.handleScroll());
      }

      return () => {
        window.removeEventListener("scroll", this.handleScroll);
      };
    }
  }

  let cleanup: (() => void) | null = null;

  function initHeader() {
    cleanup?.();
    const manager = new HeaderManager();
    cleanup = manager.init();
  }

  // Initialize on page load and transitions
  initHeader();
  document.addEventListener("astro:page-load", initHeader);
  document.addEventListener("astro:before-preparation", () => cleanup?.());
</script>

<style lang="scss">
  @use "sass:color";
  @use "../styles/variables" as *;
  @use "../styles/mixins" as *;

  .header {
    position: absolute;
    top: $space-md;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - $space-md * 2);
    max-width: 1700px;
    z-index: 1000;
    background-color: transparent;
    padding: $space-lg 0;
    border-radius: $space-lg $space-lg 0 0;
    transition:
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s,
      border-radius 0.3s,
      box-shadow 0.3s;

    @include respond-to(md) {
      top: $space-sm;
      width: calc(100% - $space-sm * 2);
      max-width: 100%;
      border-radius: $space-md $space-md 0 0;
    }

    // Shared styles for scrolled states
    &.scrolled,
    &.scrolled-no-animation {
      position: fixed;
      top: $space-md;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba($color-blue, 0.95);
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='52' height='26' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4a6 6 0 01-6-6h2c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4v2a6 6 0 01-6-6c0-2.21-1.79-4-4-4a6 6 0 01-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' fill='%23DCEEFB' fill-opacity='.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      backdrop-filter: blur(10px);
      border-radius: 50px;

      @include respond-to(md) {
        top: $space-sm;
      }
    }

    &.scrolled-no-animation {
      transition: box-shadow 0.3s;
    }

    // Add shadow only when scrolled down (not at top)
    &.has-shadow {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    &.scrolled {
      animation: slide-in-down 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    &.scrolled-exit {
      animation: slide-out-up 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    &__container {
      max-width: $max-width;
      margin: 0 auto;
      padding: 0 $space-xl;
      display: flex;
      justify-content: space-between;
      align-items: center;

      @include respond-to(md) {
        padding: 0 $space-lg;
      }
    }

    &__logo {
      color: $color-text-light;
      font-size: $font-size-sm;
      font-weight: 600;
      letter-spacing: 0.02em;
      background-color: $color-blue-dark;
      padding: $space-sm $space-lg;
      border-radius: 50px;
      @include transition(background-color, 0.2s);
      @include focus-visible;

      &:hover {
        background-color: color.adjust($color-blue-dark, $lightness: 5%);
        color: $color-text-light;
      }

      @include respond-to(md) {
        font-size: $font-size-xs;
        padding: $space-xs $space-md;
      }
    }

    &__nav {
      display: flex;
      gap: $space-xl;

      @include respond-to(md) {
        gap: $space-lg;
      }
    }

    &__nav-link {
      color: $color-text-light;
      font-size: $font-size-sm;
      font-weight: $font-weight-semibold;
      position: relative;
      padding: $space-xs 0;
      @include focus-visible;

      &::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 6px;
        background-color: $color-orange;
        border-radius: 50%;
        opacity: 0;
        @include transition(all, 0.2s);
      }

      &:hover {
        color: $color-text-light;

        &::after {
          width: 6px;
          opacity: 1;
        }
      }

      &.active {
        &::after {
          width: 6px;
          opacity: 1;
        }
      }

      @include respond-to(md) {
        font-size: $font-size-xs;
      }
    }

    // Hide header when game is playing
    &--hidden {
      animation: slide-out-up 0.4s ease-out forwards !important;
    }

    // Show header with fade-in-down animation
    &--showing {
      animation: slide-in-down 0.4s ease-out forwards !important;
    }
  }

  @keyframes slide-out-up {
    from {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    to {
      transform: translateX(-50%) translateY(-100%);
      opacity: 0;
    }
  }

  @keyframes slide-in-down {
    from {
      transform: translateX(-50%) translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
</style>
