---
/**
 * Sticky header with scroll-aware styling.
 *
 * Transforms from transparent to solid background after scrolling past hero,
 * with smooth enter/exit animations. Active nav link updates based on current
 * scroll position to provide orientation on long pages.
 */
type Props = Record<string, never>;
---

<header class="header">
  <div class="header__container">
    <a href="/" class="header__logo">Peter Chr. JÃ¸rgensen</a>
    <nav class="header__nav" aria-label="Main navigation">
      <a href="/#projects" class="header__nav-link">Projects</a>
      <a href="/#ai" class="header__nav-link">AI</a>
      <a href="/#blog" class="header__nav-link">Blog</a>
    </nav>
  </div>
</header>

<script>
  function initHeader() {
    const header = document.querySelector(".header");
    const hero = document.querySelector("#hero") as HTMLElement | null;
    const navLinks = document.querySelectorAll(".header__nav-link");
    const sections = document.querySelectorAll("section[id], footer[id]");

    // Detect if we're on homepage (has hero) or other pages (blog, etc.)
    const isHomepage = hero !== null;

    // State machine to prevent animation interruption when scrolling rapidly
    let wasScrolled = false;
    let isAnimatingOut = false;
    let isInitialLoad = true;

    function updateActiveLink() {
      if (!header) return;

      // On non-homepage pages, show solid background immediately and skip scroll logic
      if (!isHomepage) {
        // Use no-animation class on initial load to prevent slide-down effect
        if (isInitialLoad) {
          header.classList.add("scrolled-no-animation");
          isInitialLoad = false;
        } else {
          header.classList.add("scrolled");
        }
        return;
      }

      // Homepage-only scroll behavior (requires hero element)
      if (!hero) return;

      const heroBottom = hero.offsetTop + hero.offsetHeight;
      const isScrolledPastHero = window.scrollY > heroBottom;

      // Apply solid background only after hero is fully offscreen
      if (isScrolledPastHero && !isAnimatingOut) {
        header.classList.remove("scrolled-exit");
        header.classList.add("scrolled");
        wasScrolled = true;
      } else if (!isScrolledPastHero && wasScrolled && !isAnimatingOut) {
        // Trigger exit animation
        isAnimatingOut = true;
        header.classList.add("scrolled-exit");

        // After animation completes, remove classes
        setTimeout(() => {
          header.classList.remove("scrolled", "scrolled-exit");
          wasScrolled = false;
          isAnimatingOut = false;
        }, 300);
      }

      // Highlight nav link when section is 1/3 into viewport (feels more natural
      // than waiting until section hits the very top of the screen)
      // Only works on homepage where sections exist
      let currentSection = "";
      const scrollPosition = window.scrollY + window.innerHeight / 3;

      sections.forEach((section) => {
        const el = section as HTMLElement;
        const sectionTop = el.offsetTop;
        const sectionHeight = el.offsetHeight;

        if (
          scrollPosition >= sectionTop &&
          scrollPosition < sectionTop + sectionHeight
        ) {
          currentSection = el.getAttribute("id") || "";
        }
      });

      navLinks.forEach((link) => {
        link.classList.remove("active");
        const href = link.getAttribute("href");
        // Match both #section and /#section formats
        if (href === `#${currentSection}` || href === `/#${currentSection}`) {
          link.classList.add("active");
        }
      });
    }

    if (header) {
      window.addEventListener("scroll", updateActiveLink);
      // Run on page load
      updateActiveLink();
    }

    // Return cleanup function
    return () => {
      if (header) {
        window.removeEventListener("scroll", updateActiveLink);
      }
    };
  }

  // Store handlers to prevent duplicates
  let headerCleanup: (() => void) | null = null;
  let headerInitHandler: (() => void) | null = null;
  let headerCleanupHandler: (() => void) | null = null;

  const ensureHeaderHandlers = () => {
    // Remove existing
    if (headerInitHandler) {
      document.removeEventListener("astro:page-load", headerInitHandler);
    }
    if (headerCleanupHandler) {
      document.removeEventListener("astro:before-preparation", headerCleanupHandler);
    }

    // Wrapper that manages cleanup
    headerInitHandler = () => {
      if (headerCleanup) headerCleanup();
      headerCleanup = initHeader();
    };

    headerCleanupHandler = () => {
      if (headerCleanup) {
        headerCleanup();
        headerCleanup = null;
      }
    };

    document.addEventListener("astro:page-load", headerInitHandler);
    document.addEventListener("astro:before-preparation", headerCleanupHandler);
  };

  // Run on initial page load
  headerCleanup = initHeader();
  ensureHeaderHandlers();
</script>

<style lang="scss">
  @use "sass:color";
  @use "../styles/variables" as *;
  @use "../styles/mixins" as *;

  .header {
    position: absolute;
    top: $space-md;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - $space-md * 2);
    max-width: 1700px;
    z-index: 1000;
    background-color: transparent;
    padding: $space-lg 0;
    border-radius: $space-lg $space-lg 0 0;
    @include transition(
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s,
      border-radius 0.3s
    );

    @include respond-to(md) {
      top: $space-sm;
      width: calc(100% - $space-sm * 2);
      max-width: 100%;
      border-radius: $space-md $space-md 0 0;
    }

    &.scrolled {
      position: fixed;
      top: $space-md;
      left: 50%;
      transform: translateX(-50%);
      animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      background-color: rgba($color-blue, 0.95);
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='52' height='26' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4a6 6 0 01-6-6h2c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4v2a6 6 0 01-6-6c0-2.21-1.79-4-4-4a6 6 0 01-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' fill='%23DCEEFB' fill-opacity='.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      backdrop-filter: blur(10px);
      border-radius: 50px;

      @include respond-to(md) {
        top: $space-sm;
      }
    }

    &.scrolled-no-animation {
      position: fixed;
      top: $space-md;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba($color-blue, 0.95);
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='52' height='26' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4a6 6 0 01-6-6h2c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4a6 6 0 016 6c0 2.21 1.79 4 4 4v2a6 6 0 01-6-6c0-2.21-1.79-4-4-4a6 6 0 01-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' fill='%23DCEEFB' fill-opacity='.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      backdrop-filter: blur(10px);
      border-radius: 50px;
      animation: none;

      @include respond-to(md) {
        top: $space-sm;
      }
    }

    &.scrolled-exit {
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      to {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
    }

    &__container {
      max-width: $max-width;
      margin: 0 auto;
      padding: 0 $space-xl;
      display: flex;
      justify-content: space-between;
      align-items: center;

      @include respond-to(md) {
        padding: 0 $space-lg;
      }
    }

    &__logo {
      color: $color-text-light;
      font-size: $font-size-sm;
      font-weight: 600;
      letter-spacing: 0.02em;
      background-color: $color-blue-dark;
      padding: $space-sm $space-lg;
      border-radius: 50px;
      @include transition(background-color, 0.2s);
      @include focus-visible;

      &:hover {
        background-color: color.adjust($color-blue-dark, $lightness: 5%);
        color: $color-text-light;
      }

      @include respond-to(md) {
        font-size: $font-size-xs;
        padding: $space-xs $space-md;
      }
    }

    &__nav {
      display: flex;
      gap: $space-xl;

      @include respond-to(md) {
        gap: $space-lg;
      }
    }

    &__nav-link {
      color: $color-text-light;
      font-size: $font-size-sm;
      font-weight: 500;
      position: relative;
      padding: $space-xs 0;
      @include focus-visible;

      &::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 6px;
        background-color: $color-orange;
        border-radius: 50%;
        opacity: 0;
        @include transition(all, 0.2s);
      }

      &:hover {
        color: $color-text-light;

        &::after {
          width: 6px;
          opacity: 1;
        }
      }

      &.active {
        &::after {
          width: 6px;
          opacity: 1;
        }
      }

      @include respond-to(md) {
        font-size: $font-size-xs;
      }
    }
  }
</style>
