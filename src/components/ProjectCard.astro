---
/**
 * Individual project display card.
 *
 * Supports two modes:
 * 1. Simple project: External link, icon indicator
 * 2. Full case study: Entire card clickable, internal route, arrow indicator
 *
 * Falls back to letter placeholder when image unavailable.
 */
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
  title: string;
  description: string;
  alt: string;
  tags?: string[];
  image?: ImageMetadata;
  link?: string;
  hasPage?: boolean; // True if project has MDX page (internal route)
  animationDelay?: number;
}

const {
  title,
  description,
  alt,
  tags = [],
  image,
  link,
  hasPage = false,
} = Astro.props;

// "#" is used in data to indicate "no link yet" â€” treat as missing
const hasLink = link && link !== "#";

// Determine link destination and type
const isInternal = hasPage;
const linkUrl = isInternal ? `/projects/${link}/` : link;
---

{
  isInternal && hasLink ? (
    <a
      href={linkUrl}
      class="project-card project-card--clickable"
      aria-label={`View ${title} case study`}
    >
      <div class="project-card__image-wrapper">
        {image ? (
          <Picture
            src={image}
            formats={["avif", "webp"]}
            alt={alt}
            class="project-card__image"
            loading="lazy"
            quality="mid"
            widths={[400, 600, 800]}
            sizes="(min-width: 1024px) 400px, (min-width: 768px) 45vw, 90vw"
          />
        ) : (
          <div class="project-card__placeholder" aria-hidden="true">
            <span>{title.charAt(0)}</span>
          </div>
        )}
      </div>
      <div class="project-card__content">
        <h3 class="project-card__title">
          {title}
          <svg
            class="project-card__arrow-icon"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="5" y1="12" x2="19" y2="12" />
            <polyline points="12 5 19 12 12 19" />
          </svg>
        </h3>
        <p class="project-card__description">{description}</p>
        {tags.length > 0 && (
          <div class="project-card__tags">
            {tags.map((tag) => (
              <span class="project-card__tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
    </a>
  ) : (
    <article class="project-card">
      <div class="project-card__image-wrapper">
        {image ? (
          <Picture
            src={image}
            formats={["avif", "webp"]}
            alt={alt}
            class="project-card__image"
            loading="lazy"
            quality="mid"
            widths={[400, 600, 800]}
            sizes="(min-width: 1024px) 400px, (min-width: 768px) 45vw, 90vw"
          />
        ) : (
          <div class="project-card__placeholder" aria-hidden="true">
            <span>{title.charAt(0)}</span>
          </div>
        )}
      </div>
      <div class="project-card__content">
        <h3 class="project-card__title">
          {hasLink ? (
            <a
              href={linkUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="project-card__external-link"
            >
              {title}
              <svg
                class="project-card__external-icon"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                aria-hidden="true"
              >
                <path d="M7 17L17 7M17 7H7M17 7V17" />
              </svg>
            </a>
          ) : (
            title
          )}
        </h3>
        <p class="project-card__description">{description}</p>
        {tags.length > 0 && (
          <div class="project-card__tags">
            {tags.map((tag) => (
              <span class="project-card__tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
    </article>
  )
}

<style lang="scss">
  @use "sass:color";
  @use "../styles/variables" as *;
  @use "../styles/mixins" as *;

  .project-card {
    background-color: $color-white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px $color-shadow;
    @include transition(all, 0.3s);
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    color: inherit;

    &:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px $color-shadow-hover;

      .project-card__image {
        transform: scale(1.05);
      }

      .project-card__placeholder {
        background: linear-gradient(
          135deg,
          color.adjust($color-blue, $lightness: 5%) 0%,
          $color-blue-dark 100%
        );
      }
    }

    // Clickable card state (for internal pages)
    &--clickable {
      cursor: pointer;
      @include focus-visible;

      &:hover {
        .project-card__title {
          color: $color-orange;
        }

        .project-card__arrow-icon {
          transform: translateX(4px);
          opacity: 1;
        }
      }

      &:focus-visible {
        outline: 2px solid $color-orange;
        outline-offset: 2px;
      }
    }

    &__image-wrapper {
      aspect-ratio: 16 / 10;
      overflow: hidden;
      background-color: $color-cream;
      // Reserve space to prevent CLS
      contain: layout style paint;
    }

    &__image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      @include transition(transform, 0.3s);
      // Explicit aspect-ratio for CLS prevention
      aspect-ratio: 16 / 10;
    }

    &__placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(
        135deg,
        $color-blue 0%,
        $color-blue-dark 100%
      );
      @include transition(background, 0.3s);

      span {
        font-size: $font-size-4xl;
        font-weight: 700;
        color: $color-white;
        opacity: 0.9;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
    }

    &__content {
      padding: $space-xl;
      display: flex;
      flex-direction: column;
      gap: $space-sm;
      flex-grow: 1;
    }

    &__title {
      font-size: $font-size-lg;
      font-weight: 600;
      color: $color-text-dark;
      display: flex;
      align-items: center;
      gap: $space-xs;
      @include transition(color, 0.2s);
    }

    // Arrow icon for internal pages (full card clickable)
    &__arrow-icon {
      opacity: 0.6;
      flex-shrink: 0;
      @include transition(all, 0.2s);
    }

    // External link styling (title-only clickable)
    &__external-link {
      color: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: $space-xs;
      border-radius: 4px;
      @include focus-visible;

      &:hover {
        color: $color-orange;
      }
    }

    &__external-icon {
      opacity: 0.6;
      @include transition(transform, 0.2s);

      .project-card__external-link:hover & {
        transform: translate(2px, -2px);
        opacity: 1;
      }
    }

    &__description {
      font-size: $font-size-sm;
      color: $color-text-muted;
      line-height: 1.6;
      flex-grow: 1;
    }

    &__tags {
      display: flex;
      flex-wrap: wrap;
      gap: $space-xs;
      margin-top: $space-sm;
    }

    &__tag {
      font-size: $font-size-xs;
      color: $color-text-muted;
      background-color: $color-blue-pale;
      padding: $space-xs $space-sm;
      border-radius: 4px;
    }
  }
</style>
